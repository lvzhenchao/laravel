(function(){window.PhoneAuth=PhoneAuth={phone_tip:"\u7531\u4e8e\u8fd1\u671f\u8fd0\u8425\u5546\u8c03\u6574\u4e86\u77ed\u4fe1\u53d1\u9001\u89c4\u5219\uff0c\u53ef\u80fd\u9020\u6210\u4fe1\u606f\u53d1\u9001\u5ef6\u8fdf\u3002\u5982\u679c\u60a8\u957f\u65f6\u95f4\u672a\u6536\u5230\u9a8c\u8bc1\u77ed\u4fe1\uff0c\u8bf7\u5c1d\u8bd5\u91cd\u65b0\u53d1\u9001",bottom_tip_html:"\u00b7\u7531\u4e8e\u7f51\u7edc\u539f\u56e0\uff0c\u53ef\u80fd\u4f1a\u6709\u5ef6\u8fdf\u3002\u5982\u679c\u60a8\u957f\u65f6\u95f4\u6ca1\u6709\u6536\u5230\uff0c\u8bf7\u518d\u6b21\u53d1\u9001\u9a8c\u8bc1\u7801",bottom_service_html:"\u00b7\u82e5\u591a\u6b21\u64cd\u4f5c\u672a\u6536\u5230\u9a8c\u8bc1\u7801\uff0c\u8bf7\u5c06\u95ee\u9898\u53cd\u9988\u7ed9\u5ba2\u670d\uff1aservice@cs.dangdang.com",window_back_html:'<div id="window_background" style="width: 100%; left: 0px; top: 0px; z-index: 99999; display: block; position: absolute; background-color:silver;filter:alpha(opacity = 50);opacity:.5;zoom:1; " ><div id="loading_id" style="position:absolute;width:190px;left:43%;display:none;text-align:center;color:#000000;font-size:large;font-weight:700" ><img src="http://customer.dangdang.com/change/images/loading_pop.gif" alt="正在为您加载.."/><br/><br/>正努力为您加载中..</div></div>',window_html:'<div id="Authentication_window" style="display:none;position:absolute;left:37%;z-index:100000" ></div>',have_phone:'<label>手机号码：</label><span class="ver_text" id="show_phone">',email_html:'<label>选择身份验证方式：</label><select id="select_auth" name="">',input_phone:'<label>手机号码：</label><input type="text" class="ver_fillin" name="input_phone" id="input_phone" maxlength="11" />',g_vcode_html:'<p><label>图形验证码：</label>\n<input id="input_g_vcode" name="g_vcode" type="text" class="ver_fillin" maxlength="4"/>\n</p>\n<p class="graphical_code"><a href="javascript:ddvcode.show_vcode(\'imgVcode\')" style="padding-top:0px;">\n<img id="imgVcode" src="" width="178" height="50" maxlength="4" /></a>\n<span class="ver_hint">看不清？</span>\n<a href="javascript:ddvcode.show_vcode(\'imgVcode\')">换张图</a></p>\n<p class="pop_list"><span id="span_g_ver_hint" class="ver_hint"></span></p>',main_html:'<div id="security_center_pop" class="security_center_pop">\n  <h3 id="title">身份验证<a href="javascript:void(0);">close</a></h3>\n  <div class="security_center_info">\n    <p class="phone_attach_tips">\u7531\u4e8e\u8fd1\u671f\u8fd0\u8425\u5546\u8c03\u6574\u4e86\u77ed\u4fe1\u53d1\u9001\u89c4\u5219\uff0c\u53ef\u80fd\u9020\u6210\u4fe1\u606f\u53d1\u9001\u5ef6\u8fdf\u3002\u5982\u679c\u60a8\u957f\u65f6\u95f4\u672a\u6536\u5230\u9a8c\u8bc1\u77ed\u4fe1\uff0c\u8bf7\u5c1d\u8bd5\u91cd\u65b0\u53d1\u9001</p>\n    <p id="verify_mode">\n    </p>\n    <div id="div_verification">\n        <p id="p_get_vcode" class="pop_list clearfix">\n            <span id="span_verification_btn" class="verification_btn">\n                <input type="button" id="input_verification_btn" class="verification_btn" value="获取验证码">\n            </span>\n            <span id="span_get_vcode_hint" class="ver_error" style="margin-left:5px;"></span>\n        </p>\n        <p><label>验证码：</label>\n            <input id="input_vcode" name="vcode" type="text" disabled="disabled" class="ver_fillin ver_fillin_noborder" maxlength="6"/>\n        </p>\n        <p class="pop_list">\n            <span id="span_ver_hint" class="ver_hint"></span>\n        </p>\n    </div>\n    <div  id="div_g_verification" style="display:none">\n    </div>\n    <p class="pop_list_btn">\n        <input type="hidden" value="" id="type">\n        <input type="hidden" value="" id="second_verify">\n        <input type="hidden" value="" id="ver_step">\n        <input type="button" class="btn_determine" value="确定" name="" id="btn_comfirm">\n    </p>\n  </div>\n  <div class="security_bottom_hint">\u00b7\u7531\u4e8e\u7f51\u7edc\u539f\u56e0\uff0c\u53ef\u80fd\u4f1a\u6709\u5ef6\u8fdf\u3002\u5982\u679c\u60a8\u957f\u65f6\u95f4\u6ca1\u6709\u6536\u5230\uff0c\u8bf7\u518d\u6b21\u53d1\u9001\u9a8c\u8bc1\u7801<br />\n  \u00b7\u82e5\u591a\u6b21\u64cd\u4f5c\u672a\u6536\u5230\u9a8c\u8bc1\u7801\uff0c\u8bf7\u5c06\u95ee\u9898\u53cd\u9988\u7ed9\u5ba2\u670d\uff1aservice@cs.dangdang.com</div>\n</div>',script:'<script type="text/javascript">jQuery("#Authentication_window").security_pop({});<\/script>',success_module:'<div id="security_center_success_pop" class="security_center_pop"  style="display:none;">\n  <h3>身份验证<a href="javascript:void(0);">close</a></h3>\n  <div class="security_center_success"><span class="pop_icon">验证成功！</span></div>\n</div>',return_data:'<input type="hidden" value="" id="return_data" name="return_data"/>',include_jquery:function(){var default_jquery_file="http://static.dangdang.com/js/shoppinglist/jquery-1.4.2.min.js";var notHave=false;if(typeof jQuery==="undefined"){notHave=true}else{if(jQuery.fn.jquery.substr(0,1)<1||jQuery.fn.jquery.substr(2,1)<4){notHave=true}}if(notHave){var jquery_file=default_jquery_file;PhoneAuth.include_js(jquery_file,PhoneAuth.createFunc)}else{PhoneAuth.createFunc()}},include_js:function(file,func){var h=document.getElementsByTagName("head")[0];var link=document.createElement("script");link.language="javascript";link.type="text/javascript";link.src=file;if(document.all){link.onreadystatechange=function(){if(link.readyState=="complete"||link.readyState=="loaded"){func()}}}else{link.onload=function(){func()}}h.appendChild(link)},include_css:function(file,func){var browser_type=PhoneAuth.getBrowserVersion().type;if(browser_type!="firefox"&&browser_type!="ie"&&browser_type!="opera"){var webkit_css_cont=document.styleSheets.length}var h=document.getElementsByTagName("head")[0];var link=document.createElement("link");link.rel="stylesheet";link.type="text/css";link.href=file;h.appendChild(link);if(browser_type=="ie"||browser_type=="opera"){link.onreadystatechange=function(){if(link.readyState=="loaded"||link.readyState=="complete"){func()}}}else{if(browser_type=="firefox"){var ff_ld=setInterval(function(){try{link.sheet.cssRules;func();clearInterval(ff_ld)}catch(e){if(e.code==1000||e.code==18){func();clearInterval(ff_ld)}}},10)}else{var webkit_ld=setInterval(function(){if(document.styleSheets.length>webkit_css_cont){func();clearInterval(webkit_ld)}},10)}}},include_css_only:function(file,id){if(document.getElementById(id)==undefined){var h=document.getElementsByTagName("head")[0];var link=document.createElement("link");link.id=id;link.rel="stylesheet";link.type="text/css";link.href=file;h.appendChild(link)}},getBrowserVersion:function(customUa){var UNKNOW="unknow";var ua=customUa||navigator.userAgent.toLowerCase();if(!ua){return{type:UNKNOW,version:UNKNOW}}var type=UNKNOW,version=UNKNOW,v;var check=function(regex){return regex.test(ua)};if(check(/msie/)&&!check(/opera/)){type="ie";v=/msie[\/|\s]*([\d+?\.?]+)/.exec(ua)}else{if((!check(/webkit/)&&check(/gecko/)&&check(/firefox/))&&!check(/opera/)){type="firefox";v=/firefox[\/|\s]*([\d+?\.?]+)/.exec(ua)}else{if(check(/\bchrome\b/)){type="chrome";v=/chrome[\/|\s]*([\d+?\.?]+)/.exec(ua)}else{if(check(/applewebkit/)&&check(/safari/)){type="safari";v=/version[\/|\s]*([\d+?\.?]+)/.exec(ua)}else{if(check(/opera/)){type="opera";v=/version[\/|\s]*([\d+?.?]+)/.exec(ua)||/opera[\/|\s]*([\d+?.?]+)/.exec(ua)}}}}}return{type:type,version:version=(v&&v[1])?v[1]:UNKNOW}},createFunc:function(){if(jQuery("#Authentication_window")[0]){jQuery("#window_background").height(document.body.clientHeight);jQuery("#window_background").show();var window_t=document.documentElement.scrollTop||document.body.scrollTop;jQuery("#loading_id").show();jQuery("#loading_id").css({"top":window_t+250});jQuery("#Authentication_window").show();jQuery("#Authentication_window").css({"top":window_t+200});PhoneAuth.init_watchdog();return false}(function($){$.fn.security_pop=function(options){var settings={background:"#window_background",loading:"#loading_id",window:"#Authentication_window",security_pop:"#security_center_pop",security_success_pop:"#security_center_success_pop",time_miao:120};settings=$.extend({},settings,options);var $background=$(settings.background);var $loading=$(settings.loading);var $window=$(settings.window);var $security_pop=$(settings.security_pop);var $security_success_pop=$(settings.security_success_pop);var $close=$window.find("h3").children("a");var $input_phone=$("#input_phone");var $select_btn=$("#select_auth");var $span_send_vcode_btn=$("#span_verification_btn");var $send_vcode_btn=$("#input_verification_btn");var $span_send_vcode_hint=$("#span_get_vcode_hint");$span_send_vcode_hint.hide();var $input_vcode=$("#input_vcode");var $span_vcode_hint=$("#span_ver_hint");var $input_g_vcode=$("#input_g_vcode");var $span_g_vcode_hint=$("#span_g_ver_hint");var $btn_comfirm=$("#btn_comfirm");var $return_data=$("#return_data");var action=null;$close.bind("click",function(){$background.hide();$window.hide()});$input_g_vcode.bind({blur:function(){if($(this).val()==""){$span_g_vcode_hint.removeClass("ver_hint");$span_g_vcode_hint.addClass("ver_error");$(this).addClass("ver_fillin_error");$span_g_vcode_hint.html("请输入图形验证码")}},focus:function(){$span_g_vcode_hint.html("");$span_g_vcode_hint.addClass("ver_hint");$span_g_vcode_hint.removeClass("ver_error");$(this).removeClass("ver_fillin_error")},keydown:function(){}});$input_vcode.bind({blur:function(){if($(this).val()==""){$span_vcode_hint.removeClass("ver_hint");$span_vcode_hint.addClass("ver_error");$(this).addClass("ver_fillin_error");$span_vcode_hint.html("请输入验证码")}},focus:function(){$span_vcode_hint.html("");$span_vcode_hint.addClass("ver_hint");$span_vcode_hint.removeClass("ver_error");$(this).removeClass("ver_fillin_error")},keydown:function(){}});$send_vcode_btn.bind("click",function(){var type=$("#type").val();settings.time_miao=120;get_vcode(type)});$btn_comfirm.bind("click",function(){submit_to_check()});function get_vcode(type){$span_send_vcode_hint.hide();$input_phone=$("#input_phone");if(!/^1[3,4,5,7,8][0-9]{9}$/.test($input_phone.val())&&($("#ver_step").val()=="3"||$("#ver_step").val()=="4")){$span_send_vcode_hint.html("手机号格式不正确");$span_send_vcode_hint.css("display","inline-block");return false}$input_phone.addClass("ver_fillin_noborder");$input_phone.attr("disabled","true");$span_send_vcode_btn.addClass("verification_btn_none");$send_vcode_btn.attr("disabled","true");$.ajax({url:"http://customer.dangdang.com/change/p/PhoneAuthVcode.php",cache:false,data:{"input_mobile":$input_phone.val(),"type":type},jsonp:"jsoncallback",dataType:"jsonp",type:"GET",success:function(data){var flag=data.flag;if(flag=="2"){$span_send_vcode_btn.removeClass("verification_btn_none");$select_btn.removeAttr("disabled");$send_vcode_btn.removeAttr("disabled");$span_send_vcode_hint.html("验证码发送次数已超过上限");$span_send_vcode_hint.css("display","inline-block");return false}else{if(flag=="3"){$span_send_vcode_btn.removeClass("verification_btn_none");$select_btn.removeAttr("disabled");$send_vcode_btn.removeAttr("disabled");$span_send_vcode_hint.html("发送验证码失败");$span_send_vcode_hint.css("display","inline-block");return false}else{if(flag=="4"){$span_send_vcode_btn.removeClass("verification_btn_none");$select_btn.removeAttr("disabled");$input_phone.removeClass("ver_fillin_noborder");$input_phone.removeAttr("disabled");$send_vcode_btn.removeAttr("disabled");$span_send_vcode_hint.html("手机号已存在");$span_send_vcode_hint.css("display","inline-block");return false}else{if(flag=="5"){var return_url="http://login.dangdang.com/SignIn.aspx?ReturnUrl="+window.location.href;window.location.href=return_url}else{if(flag=="0"){change_timing();if(data.mode=="email"){var email_domain=loginEmail(data.email);if(!email_domain){if(!$("#span_get_ver_ok")[0]){$span_send_vcode_btn.after('<span id="span_get_ver_ok" class="ver_ok">验证码已发送至邮箱!</span>')}}else{if(!$("#span_get_ver_ok")[0]){$span_send_vcode_btn.after('<span id="span_get_ver_ok" class="ver_ok">验证码已发送!立即<a href="'+email_domain+'" target="_blank">登录邮箱</a></span>')}}}else{if(!$("#span_get_ver_ok")[0]){$span_send_vcode_btn.after('<span id="span_get_ver_ok" class="ver_ok">验证码已发送至手机!</span>')}}}}}}}}});return false}function change_timing(){var miao=settings.time_miao--;var fen,smiao;fen=parseInt(miao/60);smiao=miao-(fen*60);var fenstr="";if(fen>0){fenstr=fen+"分"}$input_vcode.removeAttr("disabled");$input_vcode.removeClass("ver_fillin_noborder");if(miao>0){$select_btn.attr("disabled","true");$send_vcode_btn.attr("disabled","true");$span_send_vcode_btn.addClass("verification_btn_none");$send_vcode_btn.css("width","130px");$send_vcode_btn.val(fenstr+smiao+"秒后重新获取");action=setTimeout(change_timing,1000)}else{$input_phone.removeClass("ver_fillin_noborder");$input_phone.removeAttr("disabled");$span_send_vcode_btn.removeClass("verification_btn_none");$select_btn.removeAttr("disabled");$send_vcode_btn.removeAttr("disabled");$send_vcode_btn.css("width","114px");$send_vcode_btn.val("重新获取验证码");$("#span_get_ver_ok").replaceWith("")}}function submit_to_check(){if($input_g_vcode.val()==""&&$("#div_g_verification").css("display")!=="none"){$span_g_vcode_hint.removeClass("ver_hint");$span_g_vcode_hint.addClass("ver_error");$input_g_vcode.addClass("ver_fillin_error");$span_g_vcode_hint.html("请输入图形验证码");return false}if(!/^\S{4}$/.test($input_g_vcode.val())&&$("#div_g_verification").css("display")!=="none"){$span_g_vcode_hint.removeClass("ver_hint");$span_g_vcode_hint.addClass("ver_error");$input_g_vcode.addClass("ver_fillin_error");$span_g_vcode_hint.html("图形验证码输入错误");return false}if($input_vcode.val()==""){$span_vcode_hint.removeClass("ver_hint");$span_vcode_hint.addClass("ver_error");$input_vcode.addClass("ver_fillin_error");$span_vcode_hint.html("请输入验证码");return false}if(!/^\S{6,20}$/.test($input_vcode.val())){$span_vcode_hint.removeClass("ver_hint");$span_vcode_hint.addClass("ver_error");$span_vcode_hint.html("验证码输入错误");$input_vcode.addClass("ver_fillin_error");return false}var ver_step=$("#ver_step").val();var input_phone=$input_phone.val();var input_vcode=$input_vcode.val();$.ajax({url:"http://customer.dangdang.com/change/p/PhoneAuthSubmit.php",cache:false,data:{"input_mobile":input_phone,"g_vcode":$("#div_g_verification").css("display")!=="none"?$input_g_vcode.val():0,"type":$("#type").val(),"sms_verify_code":input_vcode,"second_verify":$("#second_verify").val(),"ver_step":ver_step},jsonp:"jsoncallback",dataType:"jsonp",type:"GET",success:function(data){if(data.g_vcode_exists==0){if(data.vcode_flag==1){if(ver_step==="2"){intiInputMobile(data.email+"|"+data.vcode);return false}success(data.phone,data.vcode,data.verify_type)}else{if(data.vcode_flag==2){$span_vcode_hint.removeClass("ver_hint");$span_vcode_hint.addClass("ver_error");$input_vcode.addClass("ver_fillin_error");$span_vcode_hint.html("验证码输入错误或已失效");if(data.danger_flag==1){$("#div_g_verification").show()}return false}else{if(data.vcode_flag==3||data.vcode_flag==4||data.vcode_flag==5){var return_url="http://login.dangdang.com/SignIn.aspx?ReturnUrl="+window.location.href;window.location.href=return_url}else{}}}}else{if(data.g_vcode_flag==1){if(data.vcode_flag==1){if(ver_step==="2"){intiInputMobile(data.email+"|"+data.vcode);return false}success(data.phone,data.vcode,data.verify_type)}else{if(data.vcode_flag==2){$span_vcode_hint.removeClass("ver_hint");$span_vcode_hint.addClass("ver_error");$input_vcode.addClass("ver_fillin_error");$span_vcode_hint.html("验证码输入错误");ddvcode.show_vcode("imgVcode");$input_g_vcode.val("");if(data.danger_flag==1){$("#div_g_verification").show()}return false}else{if(data.vcode_flag==3||data.vcode_flag==4||data.vcode_flag==5){var return_url="http://login.dangdang.com/SignIn.aspx?ReturnUrl="+window.location.href;window.location.href=return_url}else{}}}}else{$span_g_vcode_hint.removeClass("ver_hint");$span_g_vcode_hint.addClass("ver_error");$input_g_vcode.addClass("ver_fillin_error");$span_g_vcode_hint.html("图形验证码输入错误");ddvcode.show_vcode("imgVcode");$input_g_vcode.val("");if(data.danger_flag==1){$("#div_g_verification").show()}return false}}}});return false}function intiInputMobile(verify_str){$("#verify_mode").html(PhoneAuth.input_phone);$("#type").val("mobile");$("#ver_step").val("3");$("#second_verify").val(verify_str);if(action){clearTimeout(action)}$input_phone.removeClass("ver_fillin_noborder");$input_phone.removeAttr("disabled");$input_vcode.val("");$input_vcode.attr("disabled","true");$input_vcode.addClass("ver_fillin_noborder");$input_g_vcode.val("");$span_send_vcode_btn.removeClass("verification_btn_none");$send_vcode_btn.removeAttr("disabled");$send_vcode_btn.val("获取验证码");$send_vcode_btn.css("width","90px");$("#span_get_ver_ok").replaceWith("");ddvcode.show_vcode("imgVcode");$(".phone_attach_tips").show()}function closeAll(){$close.click()}function success(phone,vcode,verify_type){$return_data.val(phone+"|"+vcode+"|"+verify_type);$security_pop.hide();$security_success_pop.show();setTimeout(closeAll,2000)}function loginEmail(email){var hash={"qq.com":"http://mail.qq.com","gmail.com":"http://mail.google.com","sina.com":"http://mail.sina.com.cn","163.com":"http://mail.163.com","126.com":"http://mail.126.com","yeah.net":"http://www.yeah.net/","sohu.com":"http://mail.sohu.com/","tom.com":"http://mail.tom.com/","sogou.com":"http://mail.sogou.com/","139.com":"http://mail.10086.cn/","hotmail.com":"http://www.hotmail.com","live.com":"http://login.live.com/","live.cn":"http://login.live.cn/","live.com.cn":"http://login.live.com.cn","189.com":"http://webmail16.189.cn/webmail/","yahoo.com.cn":"http://mail.cn.yahoo.com/","yahoo.cn":"http://mail.cn.yahoo.com/","eyou.com":"http://www.eyou.com/","21cn.com":"http://mail.21cn.com/","188.com":"http://www.188.com/","foxmail.com":"http://www.foxmail.com"};var url=email.split("@")[1];if(hash[url]!=undefined){return hash[url]}else{return false}}}})(jQuery);PhoneAuth.createHtml()},createHtml:function(){var css_file="http://customer.dangdang.com/change/static/phone_attach.css?r="+Math.random();PhoneAuth.include_css_only(css_file,"phone_attach");jQuery(document.body).append(PhoneAuth.window_back_html);jQuery(document.body).append(PhoneAuth.window_html);jQuery("#Authentication_window").html(PhoneAuth.main_html);jQuery("#Authentication_window").append(PhoneAuth.success_module);jQuery(document.body).append(PhoneAuth.return_data);jQuery("#window_background").height(document.body.clientHeight);jQuery("#window_background").show();var window_t=document.documentElement.scrollTop||document.body.scrollTop;jQuery("#loading_id").show();jQuery("#loading_id").css({"top":window_t+250});jQuery("#Authentication_window").css({"top":window_t+200});jQuery("#div_g_verification").html(PhoneAuth.g_vcode_html);PhoneAuth.check_verify_mode();jQuery(document.body).append(PhoneAuth.script);PhoneAuth.init_watchdog()},check_verify_mode:function(){jQuery.ajax({url:"http://customer.dangdang.com/change/p/Authentication.php",cache:false,data:"",jsonp:"jsoncallback",dataType:"jsonp",type:"GET",success:function(data){if(typeof data.mobile_phone!=="undefined"){PhoneAuth.have_phone=PhoneAuth.have_phone+data.mobile_phone+"</span>";jQuery("#verify_mode").html(PhoneAuth.have_phone);jQuery(".phone_attach_tips").show();jQuery("#type").val("mobile");jQuery("#ver_step").val("1");jQuery("#input_verification_btn").click()}else{if(data.is_share_user=="1"){jQuery("#verify_mode").html(PhoneAuth.input_phone);jQuery(".phone_attach_tips").show();jQuery("#type").val("mobile");jQuery("#ver_step").val("4")}else{var email=typeof data.email!=="undefined"?data.email:data.unvalidated_email;PhoneAuth.email_html=PhoneAuth.email_html+'<option value="email" >邮箱['+email+"]</option>"+"</select>";jQuery("#verify_mode").html(PhoneAuth.email_html);jQuery(".phone_attach_tips").hide();jQuery("#type").val("email");jQuery("#ver_step").val("2")}}ddvcode.show_vcode("imgVcode");jQuery("#Authentication_window").show();jQuery("#input_verification_btn").css("width","90px")}})},init_watchdog:function(){jQuery.ajax({url:"http://customer.dangdang.com/change/p/WatchDog.php",cache:false,data:"",jsonp:"jsoncallback",dataType:"jsonp",type:"GET",success:function(watch_dog_data){if(watch_dog_data.danger_flag==1){jQuery("#div_g_verification").show()}else{jQuery("#div_g_verification").hide()}}})},init:function(){PhoneAuth.include_jquery()}}})();